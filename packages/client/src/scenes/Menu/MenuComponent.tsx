import { UserRecord } from '@celluloid/types';
import {
  AppBar,
  Button,
  ClickAwayListener,
  createStyles,
  Grow,
  MenuItem,
  MenuList,
  Paper,
  Popper,
  Theme,
  Toolbar,
  Typography,
  WithStyles,
  withStyles,
} from '@material-ui/core';
import { closeSignin, openLogin, openSignup } from 'actions/Signin';
import { getButtonLink } from 'components/ButtonLink';
import SigninDialog, { SigninState } from 'components/Signin';
import * as React from 'react';
import { WithI18n, withI18n } from 'react-i18next';
import { connect } from 'react-redux';
import { NavLink } from 'react-router-dom';
import { AnyAction, Dispatch } from 'redux';
import { EmptyAction } from 'types/ActionTypes';
import { AppState } from 'types/StateTypes';

import SigninBar from './components/SigninBar';

const styles = ({ typography, spacing, palette }: Theme) =>
  createStyles({
    root: { height: '100%' },
    grow: { flex: 1 },
    homeLink: {
      color: palette.grey[600],
      fontSize: typography.h4.fontSize,
      fontWeight: typography.h4.fontWeight,
      fontFamily: typography.h4.fontFamily,
      textTransform: 'none',
      textDecoration: 'none'
    },
    content: {
      paddingTop: spacing.unit * 8,
      height: '100%'
    },
    footer: {
      paddingTop: spacing.unit * 3,
      width: '100%',
      textAlign: 'center',
      marginBottom: spacing.unit * 9
    },
    copyright: {
      color: palette.grey[600]
    },
    footerLink: {
      ...typography.caption,
      color: palette.grey[600],
      display: 'inline',
      textDecoration: 'underline'
    }
  });

interface Props extends WithStyles<typeof styles> {
  user?: UserRecord;
  signinDialog: SigninState;
  Content: React.ComponentType;
  menuAnchor?: HTMLElement;
  onOpenLangMenu(element: EventTarget): void;
  onCloseLangMenu(): void;
  onLangChange(lang: string): void;
  onClickLogin(): EmptyAction;
  onClickSignup(): EmptyAction;
  onCloseSignin(): EmptyAction;
  onClickLogout(): Promise<AnyAction>;
}

const mapStateToProps = (state: AppState) => {
  return {
    user: state.user,
    signinDialog: state.signin.dialog
  };
};

const mapDispatchToProps = (dispatch: Dispatch) => {
  return {
    onClickLogin: () => dispatch(openLogin()),
    onClickSignup: () => dispatch(openSignup()),
    onCloseSignin: () => dispatch(closeSignin())
  };
};

export default withStyles(styles)(
  connect(
    mapStateToProps,
    mapDispatchToProps
  )(withI18n()(({
    classes,
    user,
    menuAnchor,
    onOpenLangMenu,
    onCloseLangMenu,
    onLangChange,
    onClickLogin,
    onClickSignup,
    onClickLogout,
    onCloseSignin,
    Content,
    signinDialog,
    t,
    i18n
  }: Props & WithI18n) => (
      <div className={classes.root}>
        <AppBar color="default">
          <Toolbar>
            <div className={classes.grow}>
              <Button
                component={getButtonLink('/')}
                className={classes.homeLink}
              >
                                   <svg width="180" height="40">

                        <g id="surface1">
                            <path
                                fill-rule="evenodd"
                                fill="rgb(0%,29.019608%,0%)"
                                d="m151.34375,14.52344l5.9375,0
                                c0.35938,-1.75 2.17578,-3.11719 3.80078,-1.83594
                                c1.22656,0.96875 0.88281,2.26563 1.16406,3.61328
                                c0.32422,1.59375 1.14063,3.14063 2.28125,4.29297
                                c3.9375,3.97266 10.98438,2.9375 13.5,-2.13672
                                c0.59375,-1.19922 0.85938,-2.51172 0.85938,-3.84375l-4.07813,0
                                c-0.48437,0 -1.30078,-0.15234 -1.73828,0.0586
                                c-0.3125,0.15625 -0.41406,0.87109 -0.60937,1.16015
                                c-0.57813,0.91406 -1.73438,1.39063 -2.75391,0.94922
                                c-1.80078,-0.77734 -1.51562,-2.61719 -1.82031,-4.22266
                                c-0.23047,-1.20703 -0.84766,-2.4414 -1.64063,-3.36718
                                c-2.89062,-3.41407 -8.30078,-4.26172 -11.83984,-1.28125
                                c-1.17187,0.98437 -2.02734,2.19922 -2.58984,3.61718
                                c-0.38672,0.97266 -0.47266,1.96094 -0.47266,2.9961z"
                                id="svg_1"
                            />
                            <path
                                fill-rule="evenodd"
                                fill="rgb(32.941176%,50.196078%,100%)"
                                d="m151.34375,14.61328
                                c0,0.8086 -0.10156,2.10547 0.4375,2.77344
                                c0.28125,0.34375 0.85938,0.47656 1.23047,0.69922
                                c0.76953,0.44531 1.51562,1 2.09375,1.67969
                                c0.48047,0.55859 0.89453,1.13281 1.24219,1.77734
                                c0.18359,0.34766 0.3125,0.87891 0.67187,1.07422
                                c1.64063,0.90234 3.625,-0.10938 4.75781,1.83203
                                c0.17579,0.30078 0.22266,0.58594 0.23438,0.9375l6.11719,0
                                c-0.00391,-0.75781 -0.02735,-2.04688 -0.47657,-2.67578
                                c-0.28906,-0.40625 -1.05468,-0.58594 -1.46875,-0.83594
                                c-0.80468,-0.48047 -1.49609,-1.125 -2.11718,-1.82812
                                c-0.44922,-0.50391 -0.8086,-1.08204 -1.10547,-1.6875
                                c-0.16406,-0.32032 -0.27344,-0.76563 -0.60156,-0.96094
                                c-0.34766,-0.20703 -0.79688,-0.21485 -1.1836,-0.28125
                                c-1.35156,-0.21094 -2.79687,-0.04297 -3.54297,-1.46875
                                c-0.16406,-0.32422 -0.27343,-0.67969 -0.35156,-1.03516l-5.9375,0z"
                                id="svg_2"
                            />
                            <path
                                fill-rule="evenodd"
                                fill="rgb(100%,77.254902%,0%)"
                                d="m118.89063,25.47656l6.02734,0
                                c0.08984,-1.9375 2.26953,-3.04297 3.80078,-1.82422
                                c1.19531,0.95704 0.875,2.28125 1.12109,3.60157
                                c0.27735,1.49218 0.9961,2.92578 2.03907,4.02343
                                c3.47656,3.67579 9.35547,3.53516 12.67968,-0.27734
                                c0.61719,-0.70312 1.07032,-1.56641 1.40625,-2.4375
                                c0.3711,-0.94141 0.5586,-1.97656 0.5586,-2.99609l-3.98438,0
                                c-0.5625,0 -1.30859,-0.12891 -1.84375,0.03125
                                c-0.375,0.11328 -0.45703,0.875 -0.66015,1.1875
                                c-0.6211,0.95312 -1.85157,1.34375 -2.875,0.85156
                                c-1.71875,-0.82813 -1.38282,-2.75391 -1.71485,-4.31641
                                c-0.28125,-1.35547 -1.03906,-2.61718 -1.92968,-3.64453
                                c-2.8086,-3.24219 -8.19922,-3.57422 -11.47266,-0.90625
                                c-2.03906,1.66406 -3.15234,4.07813 -3.15234,6.70703z"
                                id="svg_3"
                            />
                            <path
                                fill-rule="evenodd"
                                fill="rgb(100%,69.803922%,76.470588%)"
                                d="m140.49609,25.47656l6.02735,0
                                c0.33984,-1.80468 2.16406,-3.12109 3.80078,-1.82422
                                c1.16406,0.92188 0.91016,2.56641 1.16797,3.88282
                                c0.28906,1.44531 1.10937,2.85547 2.11719,3.90234
                                c3.99609,4.15234 11.33984,3.04297 13.74609,-2.30859
                                c0.5,-1.11328 0.76172,-2.34375 0.77344,-3.5625l-4.17188,0
                                c-0.48437,0 -1.29297,-0.15235 -1.73437,0.05859
                                c-0.33203,0.16016 -0.35547,0.77734 -0.55469,1.07031
                                c-0.625,0.90625 -1.76172,1.44922 -2.80859,0.97657
                                c-1.73047,-0.77735 -1.41797,-2.44532 -1.70313,-3.97266
                                c-0.23437,-1.29297 -0.91797,-2.66016 -1.75781,-3.65234
                                c-3.20703,-3.78125 -9.07422,-4.15235 -12.58203,-0.5625
                                c-0.67578,0.6914 -1.2461,1.55078 -1.64453,2.4375
                                c-0.51172,1.14062 -0.67579,2.3125 -0.67579,3.55468z"
                                id="svg_4"
                            />
                            <path
                                fill-rule="evenodd"
                                fill="#757575"
                                d="m63.06641,18.54688
                                c0.25781,0.55468 0.9414,0.76562 1.15234,1.3164
                                c0.11719,0.30078 0.05469,0.70703 0.05469,1.02735l0,1.96093
                                c0,2.19141 0.09375,4.375 0.09375,6.5586l0,2.33593
                                c0,0.3086 0.0664,0.73829 -0.14844,0.98829
                                c-0.25,0.29296 -0.64453,0.21484 -0.96484,0.13281
                                l0,0.3789l6.58203,-0.09375l0,-0.28515l-1.10938,0
                                c0,-3.77735 -0.09375,-7.53906 -0.09375,-11.32422
                                c0,-1.08984 0.00782,-2.18359 0,-3.27344
                                c-0.0039,-0.55078 -0.1289,-1.05469 0,-1.58984
                                c-0.70312,0.0625 -1.38672,0.38281 -2.04297,0.63281
                                c-1.14453,0.43359 -2.33203,0.94922 -3.52343,1.23438z"
                                id="svg_5"
                            />
                            <path
                                fill-rule="nonzero"
                                fill="#757575"
                                d="m37.66406,16.76953
                                c-0.93359,0.48047 -1.98437,0.76172 -2.97265,1.10938
                                c-0.80469,0.29297 -1.65625,0.71093 -2.50391,0.85937
                                c0.26172,0.54297 0.94141,0.75781 1.15234,1.3125
                                c0.10547,0.28125 0.05469,0.64063 0.05469,0.9336
                                c0,0.65234 -0.04297,1.32031 0.01953,1.96484
                                c0.3125,3.32031 0.07422,6.76953 0.07422,10.10547
                                l-1.11328,0l0,0.3789l6.58594,-0.09765l0,-0.28125
                                c-0.28906,0 -0.73828,0.08203 -0.96485,-0.14844
                                c-0.20703,-0.20312 -0.15625,-0.60937 -0.1875,-0.87891
                                c-0.1289,-0.94921 -0.05468,-1.94531 -0.05468,-2.89843
                                l0,-11.05078c0,-0.42188 0.07031,-0.91407 -0.08985,-1.3086z"
                                id="svg_6"
                            />
                            <path
                                fill-rule="nonzero"
                                fill="#757575"
                                d="m45.73047,16.76953l-5.46875,1.96875
                                c0.33984,0.45703 1.02344,0.78906 1.23828,1.32422
                                c0.13672,0.34375 0.05859,0.83594 0.05859,1.19922
                                l0,11.79297l-1.11718,0l0,0.28125l6.58593,0l0,-0.3711l-1.11328,0
                                c0,-3.75 -0.09375,-7.48437 -0.09375,-11.23437l0,-3.37109
                                c0,-0.4961 0.10157,-1.125 -0.08984,-1.58985zm0,0"
                                id="svg_7"
                            />
                            <path
                                fill-rule="nonzero"
                                fill="#757575"
                                d="m19.58203,30.62109
                                c-4.6289,1.71094 -9.41406,-2.82421 -10.64062,-7.01953
                                c-0.36719,-1.26953 -0.71094,-2.71484 -0.30469,-4.02343
                                c0.375,-1.21485 1.50781,-1.64063 2.60156,-1.10547
                                c1.13672,0.5625 2.04297,1.75 2.73047,2.78906
                                c0.66797,1.01172 1.29297,2.03125 1.87891,3.08984
                                c0.33593,0.60938 0.60156,1.34375 1.04297,1.875
                                c0.61718,-1.83593 0.96093,-3.82422 1.41015,-5.71093
                                c0.10938,-0.4375 0.19141,-0.88282 0.3125,-1.3086
                                c0.0586,-0.23047 0.17188,-0.49219 0.03516,-0.71484
                                c-0.17188,-0.28906 -0.63281,-0.40625 -0.92188,-0.52344
                                c-0.92187,-0.35156 -1.90234,-0.54297 -2.875,-0.67969
                                c-3.33984,-0.46093 -7.01172,0.42969 -8.77343,3.60157
                                c-0.41407,0.75 -0.65235,1.58984 -0.82422,2.42968
                                c-0.70703,3.53907 0.71093,7.82813 3.9375,9.61719
                                c2.46093,1.35938 5.71484,1.46875 8.16406,0.02734
                                c0.92187,-0.54687 1.83203,-1.30468 2.22656,-2.34375zm0,0"
                                id="svg_8"
                            />
                            <path
                                id="svg_9"
                                d="m60.47266,21.73047
                                c-1.70703,0.92187 -3.75782,1.35547 -5.5625,2.05859
                                c0.375,0.40625 0.95312,0.71094 1.20312,1.21875
                                c0.24219,0.4961 0.09375,1.32422 0.09375,1.875l0,4.39453
                                c-0.64844,0.0586 -1.27344,0.38282 -1.83594,-0.1289
                                c-0.68359,-0.62891 -0.43359,-1.66406 -0.48828,-2.48828
                                c-0.15625,-2.24219 -0.08593,-4.5 -0.08593,-6.73828
                                c-1.875,0.60546 -3.69532,1.35937 -5.5625,1.96484l0,0.18359
                                c0.39843,0.3086 1.04296,0.70313 1.17187,1.21875
                                c0.12109,0.45703 0.02734,1.02735 0.02734,1.4961
                                c0,0.94531 0.05469,1.87109 0.09375,2.80859
                                c0.06641,1.53516 0.02735,3.38672 1.85938,3.86328
                                c0.38281,0.09766 0.80859,0.08594 1.20312,0.0625
                                c0.52344,-0.02344 1.02344,-0.23437 1.48438,-0.47265
                                c0.75781,-0.39063 1.44141,-0.89844 2.13281,-1.39063
                                c0,0.53516 0.02344,1.05078 0.09375,1.58984l5.37891,0l0,-0.3789
                                c-0.34375,0.08594 -0.67188,0.09765 -1.01953,0.09765
                                c-0.00391,-2.58203 -0.09766,-5.17968 -0.09766,-7.76953l0,-2.24609
                                c0,-0.39844 0.0625,-0.84375 -0.08984,-1.21875zm0,0"
                                fill="#757575"
                                fill-rule="nonzero"
                            />
                            <path
                                id="svg_10"
                                d="m76.14063,21.96484
                                c-0.85938,0.17969 -1.6836,0.49219 -2.40625,1.00391
                                c-2.55469,1.80469 -3.08985,5.78125 -1.08204,8.21875
                                c1.44532,1.75 3.97266,2.53906 6.1836,2.08594
                                c0.96484,-0.19531 1.875,-0.4336 2.68359,-1.03516
                                c2.45313,-1.82422 2.94922,-6.01953 0.91406,-8.35156
                                c-1.47656,-1.69922 -4.11718,-2.36719 -6.29296,-1.92188z
                                m-1,1
                                c-0.90234,0.48437 -0.29297,2.01562 -0.02343,2.70703
                                c0.77734,2.04687 1.92187,4.22656 3.44921,5.80468
                                c0.47657,0.4961 1.33204,1.45704 2.10938,1
                                c0.83984,-0.48828 0.21875,-2.02343 -0.03125,-2.68359
                                c-0.75781,-1.98828 -1.89844,-4.17578 -3.375,-5.70703
                                c-0.46875,-0.48828 -1.34375,-1.55078 -2.12891,-1.12109z"
                                fill="#757575"
                                fill-rule="evenodd"
                            />
                            <path
                                id="svg_11"
                                d="m30.98828,31.46875
                                c-1.7539,0 -3.72265,-0.55078 -4.82812,-2.05859
                                c1.40625,-0.39063 2.82031,-1.40625 3.49609,-2.71485
                                c0.77344,-1.48828 0.42578,-3.38672 -1.17187,-4.1289
                                c-0.98438,-0.45703 -2.11329,-0.39844 -3.15625,-0.25782
                                c-1.01172,0.13672 -1.96875,0.67579 -2.69141,1.39063
                                c-2.37891,2.36719 -2.33203,7.04297 0.55859,8.99609
                                c2.16797,1.46485 6.5,1.49219 7.79297,-1.22656z
                                m-3.98047,-2.21875
                                c0.8125,-2.5625 1.02344,-3.36328 0.10156,-4.96094
                                c-0.3125,-0.54297 -1.04297,-1.43359 -1.76953,-1.16015
                                c-0.74609,0.28125 -0.65625,1.29297 -0.54297,1.91015
                                c0.28516,1.51563 0.92969,3.25782 2.21094,4.21094z"
                                fill="#757575"
                                fill-rule="evenodd"
                            />

                            <path
                                id="svg_12"
                                fill="#757575"
                                d="m105.91016,16.39844
                                c-1.78516,0.71094 -3.63672,1.40625 -5.47657,1.96094
                                c0.33204,0.43359 0.8711,0.72656 1.11329,1.21875
                                c0.15625,0.3125 0.08203,0.69531 0.10156,1.02734
                                c0.02734,0.62891 0.08984,1.24219 0.08984,1.875
                                c-0.89844,-0.41016 -1.68359,-0.73047 -2.6914,-0.73047
                                c-2.9375,0 -4.97657,2.66406 -5.00782,5.50391
                                c-0.02343,2.08593 0.17969,4.91797 2.50391,5.75
                                c0.39062,0.14453 0.88281,0.21875 1.29687,0.23047
                                c0.99219,0.02343 1.98829,-0.37891 2.78516,-0.94532
                                c0.41406,-0.29687 0.74219,-0.69531 1.20313,-0.91797
                                l0,1.59375l5.3789,0l0,-0.3789l-1.11328,0l0,-7.85938
                                c0,-1.58984 0.07422,-3.19531 -0.07422,-4.77343
                                c-0.07422,-0.80079 -0.01562,-1.62891 -0.01562,-2.4336
                                c0,-0.37109 0.05078,-0.77734 -0.09375,-1.12109
                                m-4.73828,14.90625
                                c-0.22656,-1.21094 -0.09765,2.51953 -0.09765,-3.74219l0,-2.15625
                                c0,-0.51562 0.19921,-1.57812 -0.09375,-2.01953
                                c-0.59375,-0.89062 -1.91407,-0.01562 -2.25391,0.61328
                                c-0.24219,0.44532 -0.29688,0.92188 -0.39844,1.40625
                                c-0.09375,0.44532 -0.125,0.85547 -0.125,1.3086
                                c0,1.15625 -0.02344,2.37109 0.39063,3.46484
                                c0.28515,0.73828 0.83203,1.30859 1.65234,1.30859
                                c0.32422,0 0.61328,-0.08593 0.92578,-0.18359z"
                                fill-rule="evenodd"
                            />
                            <path
                                id="svg_13"
                                d="m90.89063,21.54297
                                c-1.75782,0.82812 -3.75782,1.14844 -5.47657,2.05859
                                c0.34766,0.38282 0.96875,0.73047 1.14844,1.22266
                                c0.26953,0.71484 0.05859,1.85937 0.05859,2.61719
                                c0,1.77734 0.08985,3.55078 0.08985,5.33593
                                l-1.10938,0l0,0.27735l6.58594,0l0,-0.27735l-1.11719,0
                                c0,-2.5625 -0.08984,-5.11328 -0.08984,-7.67968l0,-2.33594
                                c0,-0.40234 0.0625,-0.84766 -0.08984,-1.21875z
                                m-3.01172,-5.35156
                                c-1.61328,0.3711 -2.12891,2.58594 -1.23828,3.88282
                                c0.60547,0.875 1.73828,1.08593 2.72265,0.875
                                c1.7461,-0.38282 2.32813,-2.82032 1.17188,-4.14063
                                c-0.61328,-0.70312 -1.79297,-0.81641 -2.65625,-0.61719z"
                                fill="#757575"
                                fill-rule="nonzero"
                            />
                        </g>
                   </svg>
              </Button>
            </div>
            <Button
              onClick={event => onOpenLangMenu(event.target)}
              color="secondary"
            >
              {i18n.language.split('_')[0]}
            </Button>
            <Popper
              open={Boolean(menuAnchor)}
              anchorEl={menuAnchor}
              transition={true}
              disablePortal={true}
            >
              {({ TransitionProps, placement }) => (
                <Grow
                  {...TransitionProps}
                  style={{ transformOrigin: placement === 'bottom' ? 'center top' : 'center bottom' }}
                >
                  <Paper>
                    <ClickAwayListener onClickAway={onCloseLangMenu}>
                      <MenuList>
                        <MenuItem
                          onClick={() => onLangChange('en_US')}
                        >
                          {`English`}
                        </MenuItem>
                        <MenuItem
                          onClick={() => onLangChange('fr_FR')}
                        >
                          {`Français`}
                        </MenuItem>
                      </MenuList>
                    </ClickAwayListener>
                  </Paper>
                </Grow>
              )}
            </Popper>
            <Button
              component={getButtonLink('/About')}
            >
              {t('menu.about')}
            </Button>
            <SigninBar
              user={user}
              onClickLogin={onClickLogin}
              onClickSignup={onClickSignup}
              onClickLogout={onClickLogout}
            />
          </Toolbar>
        </AppBar>
        <SigninDialog onCancel={onCloseSignin} state={signinDialog} />
        <div className={classes.content}>
          <Content />
        </div>
        <div className={classes.footer}>
          <Typography variant="caption" className={classes.copyright}>
            {`© 2018 Institut Catholique de Paris`}
          </Typography>
          <NavLink to="/terms-and-conditions" className={classes.footerLink}>
            {t('menu.termsAndConditions')}
          </NavLink>
          {` - `}
          <NavLink to="/legal-notice" className={classes.footerLink}>
            {t('menu.legalNotice')}
          </NavLink>
        </div>
      </div >
    )
  ))
);
